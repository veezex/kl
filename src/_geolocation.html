<script type="text/javascript">
  $(document).ready(function(){
    var currentCity = window.config.currentCity;
    $('.current-city').text(currentCity.name); // Ставим актуальный город по геолокации
    $('.your-city span').text(currentCity.name + '?'); // Ставим актуальный город по геолокации

    //выводим табличку с подтвержденим актуального города
    setTimeout(function() {
      $('.current-city-choose').addClass('current-city-choose--active');
    }, 700)

    //скрываем табличку
    $('.submit-city').click(function(e) {
      e.preventDefault();
      $('.current-city-choose').removeClass('current-city-choose--active');
    });

    // открываем модалку с выбором города
    $('.other-city').click(function(e) {
      e.preventDefault();
      $('.current-city-choose').removeClass('current-city-choose--active');
      $('.modal-item').addClass('modal-item--active');
      $('body').addClass('overflow');
    });

    $('.close-modal').click(function(e) {
      e.preventDefault();
      $('.modal-item').removeClass('modal-item--active');
      $('body').removeClass('overflow');
    });

    $('.modal-overlay').click(function(e) {
      e.preventDefault();
      $('.modal-item').removeClass('modal-item--active');
      $('body').removeClass('overflow');
    })

    var cities = window.config.geoCities;
    var regions = window.config.geoRegions;

    function asc_sort(a, b){
      return (b.name) < (a.name) ? 1 : -1;
    }

    // загружаем список регионов
    function regionsLoad(){
      $.ajax({
        url: regions,
        dataType : "json",
        success: function (data) {
          data.sort(asc_sort);
          var regionsArray = [];

          $.each(data, function(i, val) {
            var item = {};
            var letter = val.name.charAt(0);
            item.title = letter;
            item.items = data.filter(item => item.name.charAt(0) == letter);
            regionsArray.push(item);
          });

         var nextRegions = regionsArray.sort(function(a,b){return a.title < b.title ? -1 : 1;}).reduce(function(arr, el){
            if(!arr.length || arr[arr.length - 1].title != el.title) {
              arr.push(el);
            }
            return arr;
          }, []);

          $.each(nextRegions, function(i, val) {
            $('.all-regions').append(
              '<div class="region-row"><div class="first-letter">' + val.title + '</div><ul class="region-list" data-letter="' + val.title + '"></ul></div>'
            );

            $.each(val.items, function(i, val) {
              var letter = val.name.charAt(0);
              $('.region-list[data-letter="' + letter + '"]').append(
                '<li class="region" data-region="' + val.id + '"><span>' + val.name + '</span></li>'
              );
            });
          });

          $('.region').click(function(){
            var id = $(this).data('region');
            $('.cities').html('');
            $.ajax({
              url: cities,
              dataType : "json",
              success: function (data) {
                data.sort(asc_sort);
                var citiesArray = [];

                $.each(data, function(i, val) {
                  if(val.rid == id) {
                    var item = {};
                    var letter = val.name.charAt(0);
                    item.title = letter;
                    item.items = data.filter(item => item.name.charAt(0) == letter);
                    citiesArray.push(item);
                  }
                });

                var nextCities = citiesArray.sort(function(a,b){return a.title < b.title ? -1 : 1;}).reduce(function(arr, el){
                  if(!arr.length || arr[arr.length - 1].title != el.title) {
                    arr.push(el);
                  }
                  return arr;
                }, []);

                $.each(nextCities, function(i, val) {
                  $('.cities').append(
                    '<div class="cities-row"><div class="first-letter">' + val.title + '</div><ul class="cities-list" data-letter="' + val.title + '"></ul></div>'
                  )

                  $.each(val.items, function(i, val) {
                    var letter = val.name.charAt(0);
                    $('.cities-list[data-letter="'+ letter +'"]').append(
                      '<li class="city" data-region="' + val.id + '"><span>' + val.name + '</span></li>'
                    )

                    //выбераем город
                    $('.city').click(function(){
                      var city = $(this).text();
                      $('.current-city').text(city);
                      $('.modal-item').removeClass('modal-item--active');
                    });
                  });
                });
              }
            });
          });
        }
      });
    }

    // загружаем список городов
    function citiesLoad(){
      $.ajax({
        url: cities,
        dataType : "json",
        success: function (data) {
          data.sort(asc_sort);
          var citiesArray = [];

          $.each(data, function(i, val) {
            var item = {};
            var letter = val.name.charAt(0);
            item.title = letter;
            item.items = data.filter(item => item.name.charAt(0) == letter);
            citiesArray.push(item);
          });

          var nextCities = citiesArray.sort(function(a,b){return a.title < b.title ? -1 : 1;}).reduce(function(arr, el){
            if(!arr.length || arr[arr.length - 1].title != el.title) {
              arr.push(el);
            }
            return arr;
          }, []);

          $.each(nextCities, function(i, val) {
            $('.cities').append(
              '<div class="cities-row"><div class="first-letter">' + val.title + '</div><ul class="cities-list" data-letter="' + val.title + '"></ul></div>'
            )

            $.each(val.items, function(i, val) {
              var letter = val.name.charAt(0);
              $('.cities-list[data-letter="'+ letter +'"]').append(
                '<li class="city" data-region="' + val.id + '"><span>' + val.name + '</span></li>'
              )
            });
          });

          //выбераем город
          $('.city').click(function(){
            var city = $(this).text();
            $('.current-city').text(city);
            $('.modal-item').removeClass('modal-item--active');
          })
        }
      });
    }

    regionsLoad();
    citiesLoad();

    // Открываем выбор города
    $('.current-city').click(function(){
      $('.modal-item').addClass('modal-item--active');
      $('body').addClass('overflow');
    });

    $('.all-cities').click(function(){
      $('.cities').html('');
      citiesLoad();
    });
  });
</script>
